<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Engine | Control Panel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <style>
        /* Deep Dark Theme Configuration */
        body { background-color: #0e0e10; color: #e3e3e3; font-family: 'Inter', system-ui, sans-serif; }
        .sidebar { background-color: #171719; border-right: 1px solid #2d2d30; }
        .input-pill { background-color: #1e1e21; border: 1px solid #3c4043; border-radius: 32px; }
        .thought-section { background-color: #161618; border-left: 2px solid #3c4043; margin: 10px 0; }
        .source-tag { background: #2d2d30; border: 1px solid #3c4043; border-radius: 6px; padding: 2px 8px; font-size: 11px; color: #a1a1a6; cursor: help; }
        .eval-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #2d2d30; border: 1px solid #3c4043; }
        #progress-bar { height: 2px; background: linear-gradient(90deg, #4285f4, #d96570); transition: width 0.3s; }
        
        /* Layout & Component Styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #2d2d30; border-radius: 10px; }
        .prose pre { background-color: #1e1e21 !important; border: 1px solid #3c4043; padding: 1rem; border-radius: 0.75rem; }
        .prose code { color: #4285f4; font-weight: 500; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#0e0e10]">

    <aside class="sidebar w-72 flex flex-col p-4 hidden lg:flex">
        <div class="mb-8 px-2 flex items-center">
            <img src="/logo.png" alt="Aether Logo" class="w-10 h-10 mr-3 drop-shadow-[0_0_10px_rgba(66,133,244,0.5)]">
            <span class="font-bold text-lg tracking-tight text-gray-100">Aether Engine</span>
        </div>
        
        <button onclick="resetSystem()" class="flex items-center gap-3 px-4 py-3 bg-[#202124] hover:bg-[#2d2f31] rounded-2xl text-sm transition mb-6 shadow-sm text-gray-200">
            <i class="fa-solid fa-plus text-blue-400"></i><span>New Session</span>
        </button>

        <div class="flex-1 overflow-y-auto space-y-6">
            <div>
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest px-2 mb-4">Indexed Documents</p>
                <div id="source-list" class="space-y-2"></div>
            </div>

            <div class="px-2 pt-6 border-t border-[#2d2d30]">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Resource Monitor</p>
                <div class="space-y-4 bg-[#1e1e21] p-3 rounded-xl border border-[#3c4043]">
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="text-gray-400">CPU Usage</span>
                            <span id="cpu-val" class="text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-[#2d2d30] h-1.5 rounded-full overflow-hidden">
                            <div id="cpu-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="text-gray-400">VRAM Usage</span>
                            <span id="vram-val" class="text-purple-400">0 / 0 MB</span>
                        </div>
                        <div class="w-full bg-[#2d2d30] h-1.5 rounded-full overflow-hidden">
                            <div id="vram-bar" class="bg-purple-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#0e0e10]">
        <div id="chat-window" class="flex-1 overflow-y-auto px-6 md:px-24 py-10 space-y-12 pb-48">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-80">
                <h1 class="text-4xl font-medium mb-4 text-white font-serif italic">Aether</h1>
                <p class="text-gray-400 max-w-md leading-relaxed">Local RAG system is active. Upload a PDF or provide a URL to begin semantic analysis.</p>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0e0e10] via-[#0e0e10] to-transparent">
            <div id="progress-container" class="max-w-3xl mx-auto mb-2 hidden">
                <div id="progress-bar" style="width: 0%"></div>
            </div>
            
            <div class="max-w-3xl mx-auto input-pill shadow-2xl p-2 px-4 bg-[#1e1e21]">
                <textarea id="user-input" rows="1" placeholder="Query your documents..." 
                    class="bg-transparent w-full focus:outline-none py-3 px-2 resize-none text-base text-gray-200 placeholder-gray-500" oninput="autoGrow(this)"></textarea>
                
                <div class="flex items-center justify-between mt-1 pb-1 px-1">
                    <div class="flex items-center gap-2">
                        <input type="file" id="pdf-input" hidden onchange="ingestPDF()" accept=".pdf">
                        <button onclick="document.getElementById('pdf-input').click()" class="p-2 hover:bg-[#3c4043] rounded-full transition text-blue-400" title="Attach PDF">
                            <i class="fa-solid fa-file-pdf"></i>
                        </button>
                    </div>
                    <button onclick="askQuestion()" class="p-2 bg-[#e3e3e3] text-black rounded-full hover:bg-white transition h-10 w-10 flex items-center justify-center shadow-md">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        /**
         * Dynamic adjustment of textarea height based on content
         */
        function autoGrow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }

        /**
         * Fetches and updates system hardware metrics from the backend
         */
        async function updateSystemStats() {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                
                document.getElementById('cpu-val').innerText = `${data.cpu_usage}%`;
                document.getElementById('cpu-bar').style.width = `${data.cpu_usage}%`;
                
                document.getElementById('vram-val').innerText = `${data.vram_used} / ${data.vram_total} MB`;
                const vramPercent = (parseInt(data.vram_used) / parseInt(data.vram_total)) * 100 || 0;
                document.getElementById('vram-bar').style.width = `${vramPercent}%`;
            } catch (e) { /* Silent fail for polling */ }
        }
        setInterval(updateSystemStats, 3000);

        /**
         * Renders messages in the chat window with Markdown support and metadata
         */
        function appendMessage(role, content, thought = null, score = null, sources = [], evaluation = null) {
            document.getElementById('empty-state').classList.add('hidden');
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in duration-500`;

            if (role === 'user') {
                msgDiv.innerHTML = `<div class="bg-[#2d2d30] px-5 py-3 rounded-3xl max-w-xl text-gray-200 leading-relaxed">${content}</div>`;
            } else {
                marked.setOptions({ highlight: (code) => hljs.highlightAuto(code).value });
                const renderedContent = marked.parse(content);
                
                msgDiv.innerHTML = `
                <div class="flex gap-4 w-full max-w-4xl">
                    <div class="flex-1">
                        ${thought ? `
                        <details class="group mb-4">
                            <summary class="flex items-center gap-2 text-[10px] font-bold text-gray-500 cursor-pointer hover:text-blue-400 transition uppercase select-none">
                                <i class="fa-solid fa-microchip group-open:text-blue-500"></i> Internal Reasoning
                            </summary>
                            <div class="thought-section mt-2 px-4 py-3 text-sm text-gray-400 italic rounded-r-lg border-[#3c4043]">
                                ${thought}
                            </div>
                        </details>` : ''}
                        
                        <div class="prose prose-invert max-w-none text-gray-200 leading-7 text-[15px]">
                            ${renderedContent}
                        </div>

                        <div class="mt-6 flex flex-col gap-3 border-t border-[#2d2d30] pt-4">
                            <div class="flex flex-wrap gap-2">
                                <span class="source-tag text-blue-400 border-blue-400/30">Confidence: ${(score*100).toFixed(0)}%</span>
                                ${sources.map((src, i) => `
                                    <span class="source-tag" title="${src.url}">
                                        Source ${i+1} ${src.page ? `(p. ${src.page})` : ''}
                                    </span>
                                `).join('')}
                            </div>
                            
                            ${evaluation ? `
                            <div class="bg-[#161618] p-3 rounded-lg border border-[#2d2d30] space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="eval-badge text-green-400">Faithfulness: ${Math.round(evaluation.faithfulness * 100)}%</span>
                                    <span class="eval-badge text-yellow-400">Relevance: ${Math.round(evaluation.relevance * 100)}%</span>
                                </div>
                                <p class="text-[11px] text-gray-500 italic">Judge Critique: ${evaluation.critique}</p>
                            </div>` : ''}
                        </div>
                    </div>
                </div>`;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }

        /**
         * Sends user query to the inference endpoint
         */
        async function askQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            appendMessage('user', question);
            input.value = '';
            input.style.height = 'auto';

            try {
                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ question })
                });
                const data = await res.json();
                appendMessage('bot', data.answer, data.thought, data.confidence_score, data.sources, data.evaluation);
            } catch (e) {
                appendMessage('bot', '**System Error:** Failed to connect to the reasoning engine.');
            }
        }

        /**
         * Handles PDF ingestion and progress tracking
         */
        function ingestPDF() {
            const fileInput = document.getElementById('pdf-input');
            const file = fileInput.files[0];
            if (!file) return;

            const progCont = document.getElementById('progress-container');
            const progBar = document.getElementById('progress-bar');
            progCont.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ingest-pdf', true);
            
            // Track upload progress
            xhr.upload.onprogress = (e) => { 
                if (e.lengthComputable) progBar.style.width = (e.loaded / e.total * 100) + '%'; 
            };
            
            xhr.onload = () => {
                progCont.classList.add('hidden');
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.status === 'success') {
                        document.getElementById('source-list').innerHTML += `
                        <div class="flex items-center gap-2 px-3 py-2 bg-[#1e1e21] rounded-xl text-[11px] text-gray-300 border border-[#3c4043] truncate animate-in slide-in-from-left duration-300">
                            <i class="fa-solid fa-file-pdf text-red-500"></i><span class="truncate">${file.name}</span>
                        </div>`;
                    } else {
                        alert(`Ingestion failed: ${data.message}`);
                    }
                } catch (err) { console.error("Parse error during ingestion"); }
            };
            xhr.send(formData);
        }

        /**
         * Clears memory on server and refreshes interface
         */
        async function resetSystem() {
            if(confirm('Wipe local memory and restart session?')) {
                try {
                    await fetch('/reset', { method: 'POST' });
                    location.reload();
                } catch(e) { alert('Reset failed.'); }
            }
        }

        // Global key listener for Enter key (without Shift)
        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                askQuestion(); 
            }
        });
    </script>
</body>
</html>