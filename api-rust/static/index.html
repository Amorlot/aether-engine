<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Engine | Dark Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <style>
        /* Tema Scuro Profondo */
        body { background-color: #0e0e10; color: #e3e3e3; font-family: 'Inter', system-ui, sans-serif; }
        .sidebar { background-color: #171719; border-right: 1px solid #2d2d30; }
        .input-pill { background-color: #1e1e21; border: 1px solid #3c4043; border-radius: 32px; }
        .thought-section { background-color: #161618; border-left: 2px solid #3c4043; margin: 10px 0; }
        .source-tag { background: #2d2d30; border: 1px solid #3c4043; border-radius: 6px; padding: 2px 8px; font-size: 11px; color: #a1a1a6; }
        .gemini-gradient { background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #progress-bar { height: 2px; background: linear-gradient(90deg, #4285f4, #d96570); transition: width 0.3s; }
        
        /* Stili per il contenuto Markdown */
        .prose strong { color: #fff; font-weight: 600; }
        .prose code { color: #e3e3e3; background-color: #2d2d30; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
        .prose pre code { background-color: transparent; padding: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose li { margin-bottom: 0.5em; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#0e0e10]">

    <aside class="sidebar w-64 flex flex-col p-4 hidden lg:flex">
        <div class="mb-8 px-2 flex items-center">
            <img src="/logo.png" alt="Aether Logo" class="w-10 h-10 mr-3 drop-shadow-[0_0_10px_rgba(66,133,244,0.5)]">
            <span class="font-bold text-lg tracking-tight text-gray-100">Aether</span>
        </div>
        
        <button onclick="resetSystem()" class="flex items-center gap-3 px-4 py-3 bg-[#202124] hover:bg-[#2d2f31] rounded-2xl text-sm transition mb-6 shadow-sm text-gray-200">
            <i class="fa-solid fa-plus text-blue-400"></i><span>Nuova Sessione</span>
        </button>
        <div class="flex-1 overflow-y-auto">
            <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest px-2 mb-4">Documenti Caricati</p>
            <div id="source-list" class="space-y-2"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#0e0e10]">
        
        <div id="chat-window" class="flex-1 overflow-y-auto px-6 md:px-24 py-10 space-y-12 pb-48">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-80">
                <h1 class="text-4xl font-medium mb-4 text-white">Analisi Intelligente</h1>
                <p class="text-gray-400 max-w-md leading-relaxed">Carica documenti o poni domande complesse. Il sistema utilizzerà il ragionamento avanzato per risponderti.</p>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0e0e10] via-[#0e0e10] to-transparent">
            <div id="progress-container" class="max-w-3xl mx-auto mb-2 hidden"><div id="progress-bar" style="width: 0%"></div></div>
            
            <div class="max-w-3xl mx-auto input-pill shadow-2xl p-2 px-4 bg-[#1e1e21]">
                <textarea id="user-input" rows="1" placeholder="Scrivi qui la tua domanda..." 
                    class="bg-transparent w-full focus:outline-none py-3 px-2 resize-none text-base text-gray-200 placeholder-gray-500" oninput="autoGrow(this)"></textarea>
                
                <div class="flex items-center justify-between mt-1 pb-1 px-1">
                    <div class="flex items-center gap-2">
                        <input type="file" id="pdf-input" hidden onchange="ingestPDF()" accept=".pdf">
                        <button onclick="document.getElementById('pdf-input').click()" class="p-2 hover:bg-[#3c4043] rounded-full transition text-blue-400" title="Allega PDF">
                            <i class="fa-solid fa-paperclip"></i>
                        </button>
                        <button class="p-2 hover:bg-[#3c4043] rounded-full transition text-gray-400 text-sm flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Ragionamento
                        </button>
                    </div>
                    <button onclick="askQuestion()" class="p-2 bg-[#e3e3e3] text-black rounded-full hover:bg-white transition h-10 w-10 flex items-center justify-center shadow-md">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-4">Il sistema può commettere errori. Verifica le informazioni importanti.</p>
        </div>
    </main>

    <script>
        function autoGrow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }

        function appendMessage(role, content, thought = null, score = null, sources = []) {
            document.getElementById('empty-state').classList.add('hidden');
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in duration-500`;

            if (role === 'user') {
                msgDiv.innerHTML = `<div class="bg-[#2d2d30] px-5 py-3 rounded-3xl max-w-xl text-gray-200 leading-relaxed">${content}</div>`;
            } else {
                // Configura marked per usare highlight.js
                marked.setOptions({
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        } else {
                            return hljs.highlightAuto(code).value;
                        }
                    }
                });
                const renderedContent = marked.parse(content);
                
                msgDiv.innerHTML = `
                <div class="flex gap-4 w-full max-w-4xl">
                    <div class="flex-1">
                        ${thought ? `
                        <details class="group mb-4" open>
                            <summary class="flex items-center gap-2 text-xs font-bold text-gray-500 cursor-pointer hover:text-blue-400 transition uppercase tracking-tighter select-none">
                                <i class="fa-solid fa-brain group-open:rotate-12 transition-transform text-blue-500"></i>
                                Processo di Ragionamento
                            </summary>
                            <div class="thought-section mt-2 px-4 py-3 text-sm text-gray-400 italic leading-relaxed rounded-r-lg">
                                ${thought}
                            </div>
                        </details>` : ''}
                        <div class="prose prose-invert max-w-none text-gray-200 leading-7">
                            ${renderedContent}
                        </div>
                        ${score ? `
                        <div class="mt-6 flex flex-wrap gap-2 items-center border-t border-[#2d2d30] pt-4">
                            <span class="source-tag text-blue-400 border-blue-400/30"><i class="fa-solid fa-bullseye mr-1"></i> Confidenza: ${(score*100).toFixed(0)}%</span>
                            ${sources.map((s, i) => `<span class="source-tag" title="${s}"><i class="fa-solid fa-link mr-1"></i> Fonte ${i+1}</span>`).join('')}
                        </div>` : ''}
                    </div>
                </div>`;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }

        async function askQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;
            appendMessage('user', question);
            input.value = '';
            input.style.height = 'auto';

            try {
                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question})
                });
                const data = await res.json();
                appendMessage('bot', data.answer, data.thought, data.confidence_score, data.sources);
            } catch (e) {
                appendMessage('bot', '**Errore critico:** Impossibile comunicare con il motore di ragionamento. Verifica che il backend sia attivo.');
            }
        }

        function ingestPDF() {
            const fileInput = document.getElementById('pdf-input');
            const file = fileInput.files[0];
            if (!file) return;

            const progCont = document.getElementById('progress-container');
            const progBar = document.getElementById('progress-bar');
            progCont.classList.remove('hidden');
            progBar.style.width = '0%';

            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ingest-pdf', true);
            xhr.upload.onprogress = (e) => { if (e.lengthComputable) progBar.style.width = (e.loaded / e.total * 100) + '%'; };
            
            xhr.onload = () => {
                progCont.classList.add('hidden');
                let data;
                try { data = JSON.parse(xhr.responseText); } catch(e) { data = {status:'error', message:'Invalid JSON response'}; }
                
                if (data.status === 'success') {
                    const list = document.getElementById('source-list');
                    list.innerHTML += `
                    <div class="flex items-center gap-2 px-3 py-2 bg-[#1e1e21] rounded-xl text-xs text-gray-300 border border-[#3c4043] truncate animate-in fade-in slide-in-from-left-2">
                        <i class="fa-solid fa-file-pdf text-red-500"></i>
                        <span class="truncate">${file.name}</span>
                    </div>`;
                } else {
                    alert('Errore durante il caricamento: ' + data.message);
                }
            };
            xhr.onerror = () => { progCont.classList.add('hidden'); alert('Errore di rete durante il caricamento.'); };
            xhr.send(formData);
        }

        async function resetSystem() {
            if(confirm('Sei sicuro di voler cancellare la memoria e iniziare una nuova sessione?')) {
                try {
                    await fetch('/reset', {method: 'POST'});
                    location.reload();
                } catch(e) {
                    alert('Errore durante il reset del sistema.');
                }
            }
        }

        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); askQuestion(); }
        });
    </script>
</body>
</html>