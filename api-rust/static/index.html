<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Engine | Control Panel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <style>
        /* Deep Dark Theme Configuration */
        body { background-color: #0e0e10; color: #e3e3e3; font-family: 'Inter', system-ui, sans-serif; }
        .sidebar { background-color: #171719; border-right: 1px solid #2d2d30; }
        .input-pill { background-color: #1e1e21; border: 1px solid #3c4043; border-radius: 32px; }
        .eval-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #2d2d30; border: 1px solid #3c4043; }
        
        /* Scrollbar & Typography */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #2d2d30; border-radius: 10px; }
        .prose pre { background-color: #1e1e21 !important; border: 1px solid #3c4043; padding: 1rem; border-radius: 0.75rem; }
        .prose code { color: #4285f4; font-weight: 500; }
        
        /* Cursor animation */
        .cursor-bit { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#0e0e10]">

    <aside class="sidebar w-72 flex flex-col p-4 hidden lg:flex">
        <div class="mb-8 px-2 flex items-center">
            <img src="/logo.png" alt="Aether Logo" class="w-10 h-10 mr-3 drop-shadow-[0_0_10px_rgba(66,133,244,0.5)]">
            <span class="font-bold text-lg tracking-tight text-gray-100">Aether Engine</span>
        </div>
        
        <button onclick="resetSystem()" class="flex items-center gap-3 px-4 py-3 bg-[#202124] hover:bg-[#2d2f31] rounded-2xl text-sm transition mb-6 shadow-sm text-gray-200 border border-[#2d2d30]">
            <i class="fa-solid fa-arrows-rotate text-blue-400"></i><span>Reset Memory</span>
        </button>

        <div class="flex-1 overflow-y-auto space-y-6">
            <div>
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest px-2 mb-4">Indexed Documents</p>
                <div id="source-list" class="space-y-2"></div>
            </div>

            <div class="px-2 pt-6 border-t border-[#2d2d30]">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Resource Monitor</p>
                <div class="space-y-4 bg-[#1e1e21] p-3 rounded-xl border border-[#3c4043]">
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="text-gray-400">CPU Usage</span>
                            <span id="cpu-val" class="text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-[#2d2d30] h-1.5 rounded-full overflow-hidden">
                            <div id="cpu-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] mb-1">
                            <span class="text-gray-400">VRAM Usage</span>
                            <span id="vram-val" class="text-purple-400">0 / 0 MB</span>
                        </div>
                        <div class="w-full bg-[#2d2d30] h-1.5 rounded-full overflow-hidden">
                            <div id="vram-bar" class="bg-purple-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#0e0e10]">
        <div id="chat-window" class="flex-1 overflow-y-auto px-6 md:px-24 py-10 space-y-12 pb-48 scroll-smooth">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center opacity-80 animate-in zoom-in duration-500">
                <h1 class="text-5xl font-medium mb-6 text-white tracking-tight">Aether</h1>
                <p class="text-gray-400 max-w-md leading-relaxed text-sm">
                    Local RAG System Online.<br>
                    Upload a PDF or enter a URL to begin semantic analysis.
                </p>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0e0e10] via-[#0e0e10] to-transparent">
            <div id="progress-container" class="max-w-3xl mx-auto mb-2 hidden">
                <div class="w-full bg-[#2d2d30] h-1 rounded-full overflow-hidden">
                    <div id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-[10px] text-gray-400 text-right mt-1">Processing...</div>
            </div>
            
            <div class="max-w-3xl mx-auto input-pill shadow-2xl p-2 px-4 bg-[#1e1e21] transition-all focus-within:ring-1 focus-within:ring-blue-500/50">
                <textarea id="user-input" rows="1" placeholder="Ask a question about your documents..." 
                    class="bg-transparent w-full focus:outline-none py-3 px-2 resize-none text-base text-gray-200 placeholder-gray-500" oninput="autoGrow(this)"></textarea>
                
                <div class="flex items-center justify-between mt-1 pb-1 px-1">
                    <div class="flex items-center gap-2">
                        <input type="file" id="pdf-input" hidden onchange="ingestPDF()" accept=".pdf">
                        <button onclick="document.getElementById('pdf-input').click()" class="p-2 hover:bg-[#3c4043] rounded-full transition text-gray-400 hover:text-white" title="Attach PDF">
                            <i class="fa-solid fa-file-pdf"></i>
                        </button>
                        <button onclick="ingestURLPrompt()" class="p-2 hover:bg-[#3c4043] rounded-full transition text-gray-400 hover:text-white" title="Add Web Source">
                            <i class="fa-solid fa-globe"></i>
                        </button>
                    </div>
                    <button onclick="askQuestion()" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-500 transition h-10 w-10 flex items-center justify-center shadow-lg hover:shadow-blue-500/30">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="text-center mt-2">
                <span class="text-[10px] text-gray-600">Powered by Rust & Llama 3.2</span>
            </div>
        </div>
    </main>

    <script>
        // --- UI Functions ---

        function autoGrow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }

        function appendMessage(role, content) {
            document.getElementById('empty-state').classList.add('hidden');
            const chatWindow = document.getElementById('chat-window');
            
            const msgRow = document.createElement('div');
            msgRow.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;

            if (role === 'user') {
                msgRow.innerHTML = `
                    <div class="bg-[#2d2d30] px-5 py-3 rounded-3xl rounded-tr-sm max-w-xl text-gray-200 leading-relaxed shadow-sm">
                        ${content}
                    </div>
                `;
            } else {
                msgRow.innerHTML = `
                <div class="flex gap-4 w-full max-w-4xl">
                    <div class="w-8 h-8 rounded-full bg-blue-600/20 flex items-center justify-center flex-shrink-0 mt-1">
                        <i class="fa-solid fa-robot text-blue-400 text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="prose prose-invert max-w-none text-gray-200 leading-7 text-[15px] bot-content">
                            <span class="inline-block w-2 h-5 bg-blue-500 animate-pulse cursor-bit"></span>
                        </div>
                        <div class="eval-container mt-4 hidden"></div>
                    </div>
                </div>`;
            }
            
            chatWindow.appendChild(msgRow);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            return msgRow;
        }

        // --- Core Logic ---

        async function askQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            appendMessage('user', question);
            input.value = '';
            input.style.height = 'auto';

            const botRow = appendMessage('bot', '');
            const contentDiv = botRow.querySelector('.bot-content');
            const evalDiv = botRow.querySelector('.eval-container');

            let fullText = "";

            try {
                // 1. Get the Answer (Streaming)
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullText += chunk;
                    contentDiv.innerHTML = marked.parse(fullText);
                    document.getElementById('chat-window').scrollTo({ top: document.getElementById('chat-window').scrollHeight, behavior: 'auto' });
                }

                // Highlight Code
                contentDiv.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));

                // 2. Call Evaluation (Background)
                evalDiv.innerHTML = `<span class="text-[10px] text-gray-500 animate-pulse">Running Judge Model...</span>`;
                evalDiv.classList.remove('hidden');

                const evalRes = await fetch('/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, answer: fullText })
                });

                if (evalRes.ok) {
                    const evalData = await evalRes.json();
                    evalDiv.innerHTML = `
                    <div class="bg-[#161618] p-3 rounded-lg border border-[#2d2d30] space-y-2 mt-2 animate-in fade-in">
                        <div class="flex items-center gap-3">
                            <span class="eval-badge text-green-400">Faithfulness: ${(evalData.faithfulness * 100).toFixed(0)}%</span>
                            <span class="eval-badge text-yellow-400">Relevance: ${(evalData.relevance * 100).toFixed(0)}%</span>
                        </div>
                        <p class="text-[11px] text-gray-500 italic">Judge Critique: ${evalData.critique}</p>
                    </div>`;
                }

            } catch (e) {
                console.error("Error:", e);
                contentDiv.innerHTML += `<br><span class="text-red-400 font-mono text-sm">Error: ${e.message}</span>`;
            }
        }

        function ingestPDF() {
            const fileInput = document.getElementById('pdf-input');
            const file = fileInput.files[0];
            if (!file) return;

            const progCont = document.getElementById('progress-container');
            const progBar = document.getElementById('progress-bar');
            progCont.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ingest-pdf', true);
            
            xhr.upload.onprogress = (e) => { 
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total * 100);
                    progBar.style.width = percent + '%'; 
                }
            };
            
            xhr.onload = () => {
                progCont.classList.add('hidden');
                progBar.style.width = '0%';
                
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.status === 'success') {
                        const list = document.getElementById('source-list');
                        list.innerHTML += `
                        <div class="flex items-center gap-2 px-3 py-2 bg-[#1e1e21] hover:bg-[#2d2d30] transition rounded-lg text-[11px] text-gray-300 border border-[#3c4043] animate-in slide-in-from-left duration-300 group cursor-default">
                            <i class="fa-solid fa-file-pdf text-red-500"></i>
                            <span class="truncate flex-1">${file.name}</span>
                            <i class="fa-solid fa-check text-green-500 text-[10px]"></i>
                        </div>`;
                        alert(`Successfully indexed: ${file.name}`);
                    } else {
                        alert(`Ingestion Error: ${data.message}`);
                    }
                } catch (err) { console.error("JSON Error", err); }
                fileInput.value = '';
            };
            
            xhr.send(formData);
        }

        async function ingestURLPrompt() {
            const url = prompt("Enter a URL to index:");
            if (!url) return;

            try {
                const res = await fetch('/ingest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    document.getElementById('source-list').innerHTML += `
                    <div class="flex items-center gap-2 px-3 py-2 bg-[#1e1e21] rounded-lg text-[11px] text-gray-300 border border-[#3c4043] truncate">
                        <i class="fa-solid fa-globe text-blue-500"></i>
                        <span class="truncate flex-1">${url}</span>
                    </div>`;
                } else {
                    alert("Error: " + data.message);
                }
            } catch (e) {
                alert("Ingestion failed: " + e.message);
            }
        }

        async function updateSystemStats() {
            try {
                const res = await fetch('/stats');
                if (!res.ok) return;
                const data = await res.json();
                
                const cpuVal = parseFloat(data.cpu_usage) || 0;
                document.getElementById('cpu-val').innerText = `${cpuVal.toFixed(1)}%`;
                document.getElementById('cpu-bar').style.width = `${Math.min(cpuVal, 100)}%`;
                
                const used = parseInt(data.vram_used);
                const total = parseInt(data.vram_total);
                if (total > 0) {
                    const vramPercent = (used / total) * 100;
                    document.getElementById('vram-val').innerText = `${used} / ${total} MB`;
                    document.getElementById('vram-bar').style.width = `${vramPercent}%`;
                }
            } catch (e) { }
        }

        async function resetSystem() {
            if(confirm('Wipe local memory and restart session?')) {
                try {
                    await fetch('/reset', { method: 'POST' });
                    location.reload();
                } catch(e) { alert('Reset failed.'); }
            }
        }

        setInterval(updateSystemStats, 2000);
        updateSystemStats();
        
        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                askQuestion(); 
            }
        });
    </script>
</body>
</html>